---
title: "Data Visualization Portfolio"
output: 
  flexdashboard::flex_dashboard:
    css: style.css
    orientation: columns
    vertical_layout: fill
---

```{r setup, include=FALSE}
library(flexdashboard)
#install.packages("naniar")
library(tidyverse)
library(here)
library(rio)
library(colorblindr)
library(ggridges)
library(ungeviz)
theme_set(theme_minimal())
```

```{r import_data}
demo <- import(here("data", "demo.csv"),
               setclass = "tbl_df")

su <- import(here("data", "su.csv"),
             setclass = "tbl_df")

pu <- import(here("data", "pu.csv"),
             setclass = "tbl_df")
```

```{r tidy}
# changing codes to years
t_demo <- demo %>% 
  janitor::clean_names() %>% 
  mutate(year = case_when(sddsrvyr == 2 ~ 2001,
                          sddsrvyr == 3 ~ 2003,
                          sddsrvyr == 4 ~ 2005,
                          sddsrvyr == 5 ~ 2007,
                          sddsrvyr == 6 ~ 2009,
                          sddsrvyr == 7 ~ 2011,
                          sddsrvyr == 8 ~ 2013,
                          sddsrvyr == 9 ~ 2015,
                          TRUE ~ NA_real_))

# creating labels for categorical variables
t_demo <- t_demo %>% 
  mutate(ethnicity = case_when(ridreth3 == 1 ~ "Hispanic", # combined to be more succinct
                               ridreth3 == 2 ~ "Hispanic", 
                               ridreth3 == 3 ~ "White",
                               ridreth3 == 4 ~ "Black",
                               ridreth3 == 6 ~ "Asian",
                               ridreth3 == 7 ~ "Other/Multiracial",
                               TRUE ~ NA_character_)) 

t_demo <- t_demo %>% 
  mutate(income = case_when(indhhin2 == 1 ~ "$0 - $4,999",
                            indhhin2 == 2 ~ "$5,000 to $9,999",
                            indhhin2 == 3 ~ "10,000 to $14,999",
                            indhhin2 == 4 ~ "$15,000 to $19,999",
                            indhhin2 == 5 ~ "$20,000 to $24,999",
                            indhhin2 == 6 ~ "$25,000 to $34,999",
                            indhhin2 == 7 ~ "$35,000 to $44,999",
                            indhhin2 == 8 ~ "$45,000 to $54,999",
                            indhhin2 == 9 ~ "$55,000 to $64,999",
                            indhhin2 == 10 ~ "$65,000 to $74,999",
                            indhhin2 == 11 ~ "$75,000 and Over",
                            indhhin2 == 12 ~ "Over $20,000",
                            indhhin2 == 13 ~ "Under $20,000",
                            indhhin2 == 14 ~ "$75,000 to $99,999",
                            indhhin2 == 15 ~ "$100,000 and over",
                            indhhin2 == 77 ~ "Refused",
                            indhhin2 == 99 ~ "Don't know",
                            TRUE ~ NA_character_))

t_demo <- t_demo %>% 
  mutate(education = case_when(dmdeduc2 == 1 ~ "No diploma/GED",
                               dmdeduc2 == 2 ~ "No diploma/GED",
                               dmdeduc2 == 3 ~ "High school graduate/GED",
                               dmdeduc2 == 4 ~ "Some college",
                               dmdeduc2 == 5 ~ "College graduate or above",
                               TRUE ~ NA_character_))

# Coding SU variables
su <- su %>% 
  janitor::clean_names() %>% 
  mutate(marijuana = case_when(duq200 == 1 ~ "Yes",
                               duq200 == 2 ~ "No",
                               TRUE ~ NA_character_)) %>% 
  mutate(cocaine = case_when(duq250 == 1 ~ "Yes",
                             duq250 == 2 ~ "No",
                             TRUE ~ NA_character_)) %>% 
  mutate(heroin = case_when(duq290 == 1 ~ "Yes",
                            duq290 == 2 ~ "No",
                            TRUE ~ NA_character_)) %>% 
  mutate(meth = case_when(duq330 == 1 ~ "Yes",
                          duq330 == 2 ~ "No",
                          TRUE ~ NA_character_))

# Coding sex variable
t_demo <- t_demo %>% 
   mutate(sex = case_when(riagendr == 1 ~ "Male", 
                         riagendr == 2 ~ "Female", 
                         TRUE ~ NA_character_)) 
# joining demo with su
d <- left_join(su, t_demo, by = "seqn")
```

```{r revised_plot1_data}
rpd <- d %>% 
  filter(heroin == "Yes" |
         cocaine == "Yes" |
         meth == "Yes" |
         marijuana == "Yes") %>% 
  select(heroin, cocaine, meth, marijuana, year, sex, ethnicity) %>% 
  rename(Heroin = heroin,
         Cocaine = cocaine,
         Meth = meth,
         Marijuana = marijuana) %>% 
  gather(drug, response, Heroin:Marijuana) %>% 
  filter(response == "Yes") %>% 
  group_by(year, drug, sex) %>% 
  count() %>% 
  filter(drug != "Marijuana") %>% 
  ungroup() %>% 
  mutate(prop = (n/sum(n)))
```

```{r plot2_data}
pud1 <- pu %>% 
  janitor::clean_names() %>% 
  filter(rxddrug == "LORAZEPAM" |
         rxddrug == "ALPRAZOLAM" |
         rxddrug == "DIAZEPAM" |
         rxddrug == "CLONAZEPAM") %>% 
  select(seqn, rxddrug, rxddays, rxdcount) %>% 
  rename(drug = rxddrug,
         days = rxddays, 
         count = rxdcount)

to_join <- t_demo %>% 
  rename(age = ridageyr) %>% 
  select(seqn, year, age, sex) 

pud <- left_join(pud1, to_join, by = "seqn") %>% 
  naniar::replace_with_na(replace = list(days = 99999)) %>% 
  mutate(year = factor(year))

rpud <- pud %>% 
  mutate(use_yr = days/365) %>% 
  filter(age != 80)
rpud$year <- fct_relevel(rpud$year, "2015", "2001") # from JP - have 2001 before 2015

rpud1 <- pud %>% 
  mutate(use_yr = days/365,
         drug = case_when(drug == "LORAZEPAM" ~ "Ativan",
                          drug == "CLONAZEPAM" ~ "Klonopin",
                          drug == "DIAZEPAM" ~ "Valium",
                          drug == "ALPRAZOLAM" ~ "Xanax",
                          TRUE ~ NA_character_)) %>% 
  filter(age != 80)
```

```{r plot3_data}
pd <- d %>% 
  rename(age_Cocaine = duq260, 
         age_Heroin = duq300, 
         age_Meth = duq340) %>% 
  filter(year != 2005) %>% 
  select(age_Cocaine, age_Heroin, age_Meth, income, sex, ethnicity, sex, education) %>% 
  gather(drug, age_use, age_Cocaine:age_Meth) %>% 
  separate(drug, c(NA, "drug"), sep = "_") %>% 
  drop_na(age_use)

pd1 <- d %>% 
  rename(age_Cocaine = duq260, 
         age_Heroin = duq300, 
         age_Meth = duq340) %>% 
  filter(year != 2005) %>% 
  select(age_Cocaine, age_Heroin, age_Meth, income, sex, year, ethnicity, education) %>% 
  gather(drug, age_use, age_Cocaine:age_Meth) %>% 
  separate(drug, c(NA, "drug"), sep = "_") %>% 
  mutate(income = case_when(income == "$0 - $4,999" ~ "Under $20,000", #grouped by 10s instead of 5s
                            income == "$5,000 to $9,999" ~ "Under $20,000",
                            income == "10,000 to $14,999" ~ "Under $20,000",
                            income == "$15,000 to $19,999" ~ "Under $20,000",
                            income == "$20,000 to $24,999" ~ "$20,000 to $34,999",
                            income == "$25,000 to $34,999" ~ "$20,000 to $34,999",
                            income == "$35,000 to $44,999" ~ "$35,000 to $54,999",
                            income == "$45,000 to $54,999" ~ "$35,000 to $54,999",
                            income == "$55,000 to $64,999" ~ "$55,000 to $99,999",
                            income ==  "$65,000 to $74,999" ~ "$55,000 to $99,999",
                            income ==  "$75,000 and Over" ~ "$75,000 and Over",
                            income ==  "Over $20,000" ~ "Over $20,000",
                            income ==  "Under $20,000" ~ "Under $20,000",
                            income ==  "$75,000 to $99,999" ~ "$55,000 to $99,999",
                            income ==  "$100,000 and over" ~ "$100,000 and over",
                            TRUE ~ NA_character_),
         income = factor(income,
                         levels = c("Under $20,000",
                                    "$20,000 to $34,999", 
                                    "$35,000 to $54,999",
                                    "55,000 to $99,999",
                                    "$100,000 and over"))) %>% 
  naniar::replace_with_na(replace = list(age_use = c(999, 777, 99, 0, 77))) %>% 
  drop_na(age_use)

pd1_rev <- pd1 %>% 
  mutate(education = factor(education,
                            levels = c("No diploma/GED",
                                       "High school graduate/GED", 
                                       "Some college",
                                       "College graduate or above",
                                       TRUE ~ NA_character_)),
         ethnicity_group = case_when(ethnicity == "Hispanic" ~ "Non- White", # combined to be more succinct
                                     ethnicity == "Hispanic" ~ "Non- White", 
                                     ethnicity == "White" ~ "White",
                                     ethnicity == "Black" ~ "Non- White",
                                     ethnicity == "Asian" ~ "Non- White",
                                     TRUE ~ NA_character_),
         drug = factor(drug,
                       levels = c("Cocaine",
                                  "Meth",
                                  "Heroin"))) %>% 
  drop_na(age_use, education)

pd1_rev_filter <- pd1_rev %>% 
  filter(year == 2015 | 
         year == 2013 ) %>% 
  filter(drug != "Marijuana")

pd1_rev_sum <- pd1_rev %>%  
  filter(year == 2015 |
         year == 2013 ) %>% 
  group_by(drug, education) %>% 
  summarize(avg_age = mean(age_use),
            n = length(age_use),
            sd = sd(age_use),
            se = sd / sqrt(n)) %>% 
  drop_na(education) %>% 
  filter(drug != "Marijuana")

p <- ggplot(pd1_rev_sum, aes(education, avg_age)) + 
  geom_jitter(aes(x = education, y = age_use, color = education), data = pd1_rev_filter, alpha = .15, width = .25) +
  geom_errorbar(aes(ymin = avg_age + qnorm(.025)*se,
                    ymax = avg_age + qnorm(.975)*se),
                width = .4) +
  geom_point(size = 1) + # add jitter from other dataset (before point)
  facet_wrap(~ drug, ncol = 1) + # added ncol = 1 to see more of variability 
  coord_flip() + #coord flip to see labels better and differences in outcome
  theme(legend.position = "none",
        plot.caption = element_text(color = "gray50", size = 7)) +
  labs(y = "Age of first use (in years)",
       x = "",
       title = "Age of First Substance Use by Education Level",
       subtitle = "Distribution and point estimate for average age of first use",
       caption = "Data from the CDC's National Health and Nutrition Examination Survey (2013-2015)")


```


# Final Visualizations {data-icon="fa-chart-area"}

Sidebar {.sidebar}
----------------------

The visualizations you will see in this portfolio came from the Center for Disease Control and Prevention's (CDC) National Health and Nutrition Examination Survey (NHANES). Data collection began in 1999 and the most recent data collected and publicly available are from 2015-2016.

These data and codebooks are available online [here](https://www.cdc.gov/nchs/nhanes/about_nhanes.htm).

NHANES surveys around 5,000 participants accross the U.S. each year. Surveys include demographic, socioeconomic, dietary, and health related questions, as well as medical records, physiological assessments, and laboratory test. 

The data presented in this portfolio come from three questionnaires: 

* Demographics 

* Drug use

* Prescription medications 

The three visualizations presented in this portfolio use various data from 2001 to 2015 to explore illicit substance use and addictive benzodiazepine prescrition use in a nationally representative sample.

The final visualizations are presented on the right. 

For more information about the evolution of each plot (i.e., how it changed over time) see individual tabs on top of this dashboard.


Column {data-width=550}
-----------------------------------------------------------------------

### Data Visualization #1: Illicit substance use trends by substance type, gender and major policy decisions in NHANES sample  

```{r final_plot1, fig.width=8}
ggplot(rpd, aes(year, n, color = drug)) + 
  geom_vline(xintercept = 2009.25, color = "black", linetype = "dotdash", size = .6) +
  geom_vline(xintercept = 2012.8, color = "black", linetype = "dotdash", size = .6) +
  geom_line(size = 1.1, alpha = .7) +
  geom_point(size = 2.5) +
  facet_wrap(~ sex) +
  geom_text(data = filter(rpd, year == 2015),
            aes(y = n, label = drug),
            hjust = .4,
            vjust = -1.25,
            fontface = "bold") +
  annotate("text", label = "End of\n'War on Drugs'", x = 2007.8, y = 525, color = "gray30", size = 3) +
  annotate("text", label = "Marijuana 1st\nLeagalized", x = 2014.2, y = 525, color = "gray30", size = 3) + #nudging annotations for clarity
  scale_x_continuous(limits = c(2005, 2016),
                     breaks = c(2005, 2007, 2009, 2011, 2013, 2015),
                     labels = c("'05", "'07", "'09", "'11", "'13", "'15")) +
  theme(legend.position = "none",
        panel.grid.minor.x = element_blank(),
        panel.grid.major = element_line(color = "#e2dfd7"),
        panel.grid.minor = element_line(color = "#e2dfd7"),
        axis.title.x = element_blank(),
        panel.background = element_rect(fill = "#f9f6ef", color = "#f9f6ef"), 
        plot.background = element_rect(fill = "#f9f6ef", color = "#f9f6ef"),
        strip.text = element_text(color = "black", face = "bold", size = 12),
        plot.title = element_text(size = 14, hjust = .35),
        plot.caption = element_text(color = "gray50", size = 7),
        axis.text = element_text(color = "gray50")) +
  labs(y = "People reporting substance use\n",
       title = "Substance use trend from 2005 to 2015 in the U.S.",
       caption = "Data from the CDC's National Health and Nutrition Examination Survey") +
  scale_color_OkabeIto() 
```

> This plot shows use of different illicit substances from 2005 to 2015 by gender. Most notably, males have a higher reported use of substances, especially cocaine. It is interesting to note that reported cocaine use declined after the end of the cultural 'War on Drugs' for both males and females, and heroin use declined for males. Also, after marijanua was legalized you can see a reduction in illicit drug use for both sexes, except for cocaine use in males. 

Column 
-----------------------------------------------------------------------



### Data Visualization #2: Distribution of addictive benzodiazepine prescription use in 2001 vs. 2015 in NHANES sample

```{r final_plot2, fig.width=7}
ggplot(rpud1, aes(use_yr, year, fill = drug)) +
  geom_density_ridges(color = "white",
                      scale = .9,
                      alpha = .5, 
                      jittered_points = TRUE, 
                      position = position_points_jitter(width = .1, 
                                                        height = 0), 
                      point_shape = '|', 
                      point_size = 2, 
                      point_alpha = .35,
                      point_color = "black") +
  facet_wrap(~ drug) +
  scale_x_continuous(limits = c(0,40)) +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        axis.text.y = element_text(face = "bold"),
        axis.text.x = element_text(color = "gray50"),
        strip.text = element_text(color = "gray30", face = "bold", size = 12),
        plot.caption = element_text(color = "gray50", size = 7)) +
  labs(x = "Years of reported use",
       title = "Distribution of Addictive Benzodiazepine Prescription Use",
       subtitle = "Differences in the number of years of reported use in 2001 vs. 2015 in the U.S.",
       caption = "Data from the CDC's National Health and Nutrition Examination Survey\n2001 Sample (n = 18,418) and 2015 Sample (n = 19,647)") +
  scale_y_discrete(expand = c(0, -1.1)) +
  scale_fill_viridis_d() +
  scale_color_viridis_d()
```


> This plot shows differences in the distribution of number of years using different addictive prescription benzodiazepines in the year 2001 compared to 2015. As shown, there are more people in general reporting any years of use of Valium and Xanax in 2015 compared to 2001. More specifically, the plot shows that more people are reporting using Ativan and Xanax for more years in 2015 compared to 2001. However, more participants reported using Kolonopin for many years in 2001 compared to 2015. 

### Data Visualization #3: Average age of first illicit substance use by substance type and education level in NHANES sample

```{r final_plot3, fig.width=7}
p + theme(plot.background = element_rect(fill = "gray10"),
        axis.text = element_text(colour = "gray80"),
        axis.title = element_text(colour = "gray80"),
        plot.title = element_text(colour = "gray80"),
        plot.subtitle = element_text(colour = "gray80"),
        plot.caption = element_text(colour = "gray80", vjust = 1),
        panel.grid.major = element_line(colour = "gray30"), 
        panel.grid.minor = element_line(colour = "gray30"),
        strip.text = element_text(color = "gray90")) +
  geom_errorbar(aes(ymin = avg_age + qnorm(.025)*se,
                    ymax = avg_age + qnorm(.975)*se),
                width = .4,
                color = "gray90") +
  geom_point(size = 1, color = "gray90")

```

> This plot shows differences in the distribution and mean age of first illicit substance use accross various education levels using data from the 2013-2015 NHANES samples. There are no observable significant differences in mean age of first use accross education levels. Although it is interesting to note that those with no high school degree reported using substances at slightly older age than those with a college degree. The most obvious observation is that more people reported using cocaine compared to both meth and heroin. However, there seems to be more variability in age of first heroin use as seen by the distribution of data points, although there were much less participants reporting any heroin use. 

# Evolution of Plot 1 {data-icon="fa-syringe"}

Sidebar Title {.sidebar}
----------------------

This plot is geared towards a general audience and aims to show trends in illicit substance use from 2005 to 2015 and explore differences related to substance type, gender, and major policy decisions. 

Substance use is a count of the number of participants that reported use of each illicit substance in the last year in each NHANES sample from 2005 to 2015. 

In the final plot, I made the following revisions:

* Added points on plot to represent acutal data values for years measured and more accurately portray data

* Added reference lines for major policies that might affect trends in use

* Changed aspect ratio to more accurately show the passage of time

* Changed color pallete to not include yellow line that is hard to see, but is still colorblind friendly

* Modified theme elements to be more visually appealing to general audience:

  * lightened axis labels and caption to grey 
  
  * increased size and bolded facet titles 
  
  * centered plot title
  
  * removed minor gridlines that did not correspond to data points

The final plot is shown immediately to the right, and the each iteration can be seen in the right panel by clicking through each tab.


Column {data-width=800}
-----------------------------------------------------------------------

### Final Revised Plot 1 

```{r revised_plot1, fig.width=8}
ggplot(rpd, aes(year, n, color = drug)) + 
  geom_vline(xintercept = 2009.25, color = "black", linetype = "dotdash", size = .6) +
  geom_vline(xintercept = 2012.8, color = "black", linetype = "dotdash", size = .6) +  
  geom_line(size = 1.1, alpha = .7) +
  geom_point(size = 2.5) +
  facet_wrap(~ sex) +
  geom_text(data = filter(rpd, year == 2015),
            aes(y = n, label = drug),
            hjust = .4,
            vjust = -1.25,
            fontface = "bold") +
  annotate("text", label = "End of\n'War on Drugs'", x = 2007.8, y = 525, color = "gray30", size = 3) +
  annotate("text", label = "Marijuana 1st\nLeagalized", x = 2014.2, y = 525, color = "gray30", size = 3) + #nudging annotations for clarity
  scale_x_continuous(limits = c(2005, 2016),
                     breaks = c(2005, 2007, 2009, 2011, 2013, 2015),
                     labels = c("'05", "'07", "'09", "'11", "'13", "'15")) +
  theme(legend.position = "none",
        panel.grid.minor.x = element_blank(),
        panel.grid.major = element_line(color = "#e2dfd7"),
        panel.grid.minor = element_line(color = "#e2dfd7"),
        axis.title.x = element_blank(),
        panel.background = element_rect(fill = "#f9f6ef", color = "#f9f6ef"), 
        plot.background = element_rect(fill = "#f9f6ef", color = "#f9f6ef"),
        strip.text = element_text(color = "black", face = "bold", size = 12),
        plot.title = element_text(size = 14, hjust = .35),
        plot.caption = element_text(color = "gray50", size = 7),
        axis.text = element_text(color = "gray50")) +
  labs(y = "People reporting substance use\n",
       title = "Substance use trend from 2005 to 2015 in the U.S.",
       caption = "Data from the CDC's National Health and Nutrition Examination Survey") +
  scale_color_OkabeIto() 
```

> This plot shows use of different illicit substances from 2005 to 2015 by gender. Most notably, males have a higher reported use of substances, especially cocaine. It is interesting to note that reported cocaine use declined after the end of the cultural 'War on Drugs' for both males and females, and heroin use declined for males. Also, after marijanua was legalized you can see a reduction in illicit drug use for both sexes, except for cocaine use in males. 

Column {.tabset}
-----------------------------------------------------------------------

### Initial Plot 

```{r initial_plot1}
h_count <- d %>% 
  group_by(year) %>% 
  count(heroin) %>% 
  filter(heroin == "Yes")

c_count <- d %>% 
  group_by(year) %>% 
  count(cocaine) %>% 
  filter(cocaine == "Yes")

me_count <- d %>% 
  group_by(year) %>% 
  count(meth) %>% 
  filter(meth == "Yes")

cj <- right_join(h_count, c_count, by = "year")
su_count1 <- right_join(cj, me_count, by = "year")

su_count <- su_count1 %>% 
  ungroup() %>% 
  rename(Heroin = n.x,
         Cocaine = n.y,
         Meth = n) %>% 
  select(year, Heroin, Cocaine, Meth) %>% 
  gather(drug, n, Heroin:Meth) 

ggplot(su_count, aes(year, n)) + 
  geom_line(aes(color = drug))
```

> This is the initial line plot I made with a count of the number of participants reporting any substance use in NHANES samples from 2005 to 2015 - colored by substance type. This default plot does show the differences in substance types and trends over time, but needs to be improved. Specifically, the year on the x axis is not formatted correctly and the arrangement of the levels in the legend are counterintuitive.  

### First Revision

```{r initial_plot1_cleaned}
ggplot(su_count, aes(year, n)) + 
  geom_line(aes(color = drug), size = 1) +
  scale_x_continuous(breaks = c(2005, 2007,
                                2009, 2011, 
                                2013, 2015),
                     labels = c("2005", "2007",
                                "2009", "2011",
                                "2013", "2015")) +
  scale_color_viridis_d() +
  ggrepel::geom_text_repel(data = filter(su_count, year == 2015),
                                         aes(label = drug)) +
  labs(x = " ",
       y = "Amount of Drug Users",
       title = "Drug Users across Years",
       caption = "Data from NHANES datasets") +
  guides(color = "none")
```

> Shown above is the first revision of the initial plot in which I changed the default colors to a colorblind friendly pallete and increased the line thickness. To further reduce cognitive load, I removed the legend and used ggrepel to add labels to the end of each trend line since the lines are far enough apart. To clean up the x axis and increase data to ink ratio, I reformatted the labels to correspond to the years of data collection and removed the "date" title that was  and obvious. Lastly, I added a plot title, y axis title, and caption for clarity. The main problem with this plot is I was not able to facet by sex because of the way I calculated summaries and joined files. Therefore, for the next iteration I had to tidy my data differently. 

### Second Revision

```{r 1stRevise_p1}
ggplot(rpd, aes(year, n, color = drug)) + 
  geom_line(size = 1.1, alpha = .7) +
  facet_wrap(~ sex) +
  geom_text(data = filter(rpd, year == 2015),
            aes(y = n, label = drug),
            hjust = .4,
            vjust = -1.25,
            fontface = "bold") +
  scale_x_continuous(limits = c(2005, 2016),
                     breaks = c(2005, 2007, 2009, 2011, 2013, 2015),
                     labels = c("'05", "'07", "'09", "'11", "'13", "'15")) +
  theme(legend.position = "none",
        axis.title.x = element_blank(),
        plot.caption = element_text(size = 7)) +
  labs(y = "People reporting substance use\n",
       title = "Substance use trend from 2005 to 2015 in the U.S.",
       caption = "Data from the CDC's National Health and Nutrition Examination Survey") +
  scale_color_viridis_d() 
```


> In order to produce this plot that is faceted by sex, I had to first had to go back to the original joined data and filter for participants that reported use, select the substances and demographics of interest, then gathered all substances and responses, grouped by year, drug, and sex, and then counted the number of participants reporting use. This resuled in a dataframe that I was able to use to facet by sex with the same data that was produced for the initial plot (but with much less code). 
To reduce overlap of labels and reduce cognitive load, I used the `annotate()` function to place labels for each substance use at the end of each trend line (instead of ggrepel) that allowed me to select the best placement for the labels. Then, I increased the limits of the x axis to account for the addition of the labels. Additionally, I abbreviated the year labels on the x axis per peer review suggestion and added space between the y axis label and the axis text - this is much easier on the eyes and just as easy to understand. I also updated the title, caption, and y axis title to be more descriptive and informative to a general audience. This is the last revision before the changes made for the final plot (as described in the sidebar).


# Evolution of Plot 2 {data-icon="fa-prescription-bottle-alt"}

Sidebar Title {.sidebar}
----------------------

This plot is geared towards an academic audience and aims to show differences in the amount of time people are reporting using addictive benzodiazepine prescriptions in 2015 compared to 2001.

The final revisions I made for this plot:

* Changed the `color` of the ridgelines to white to get rid of trailing lines connecting spaced out data points, and changed the `point_color` to black in the same function so the points wouldn't disappear when `color = "white"` 

* Slightly extended the aspect ratio width to better align with scale of x axis
 
* Removed the extra space on the y axis below the bottom categories to remove excess, useless plot space - per peer review comment

* Changed theme elements to decrease cognitive load

  * Decreased size of caption and changed color to grey so that it doesn't stand out as a focal point
  
  * Bolded and increased size of prescription categories and comparison years
  
  * Changed x axis labels to grey
  
The final plot is shown immediately to the right, and the each iteration can be seen in the right panel by clicking through each tab.


Column {data-width=800}
-----------------------------------------------------------------------

### Final Revised Plot 2 

```{r revised_plot2_final, fig.width=7}
ggplot(rpud1, aes(use_yr, year, fill = drug)) +
  geom_density_ridges(color = "white",
                      scale = .9,
                      alpha = .5, 
                      jittered_points = TRUE, 
                      position = position_points_jitter(width = .1, 
                                                        height = 0), 
                      point_shape = '|', 
                      point_size = 2, 
                      point_alpha = .35,
                      point_color = "black") +
  facet_wrap(~ drug) +
  scale_x_continuous(limits = c(0,40)) +
  theme(legend.position = "none",
        axis.title.y = element_blank(),
        axis.text.y = element_text(face = "bold"),
        axis.text.x = element_text(color = "gray50"),
        strip.text = element_text(color = "gray30", face = "bold", size = 12),
        plot.caption = element_text(color = "gray50", size = 7)) +
  labs(x = "Years of reported use",
       title = "Distribution of Addictive Benzodiazepine Prescription Use",
       subtitle = "Differences in the number of years of reported use in 2001 vs. 2015 in the U.S.",
       caption = "Data from the CDC's National Health and Nutrition Examination Survey\n2001 Sample (n = 18,418) and 2015 Sample (n = 19,647)") +
  scale_y_discrete(expand = c(0, -1.1)) +
  scale_fill_viridis_d() +
  scale_color_viridis_d()
```

> This plot shows differences in the distribution of number of years using different addictive prescription benzodiazepines in the year 2001 compared to 2015. As shown, there are more people in general reporting any years of use of Valium and Xanax in 2015 compared to 2001. More specifically, the plot shows that more people are reporting using Ativan and Xanax for more years in 2015 compared to 2001. However, more participants reported using Kolonopin for many years in 2001 compared to 2015. 

Column {.tabset data-commentary-height=1200}
-----------------------------------------------------------------------

### Initial Plot  

```{r initial_plot2}
ggplot(pud, aes(drug, days)) +
  geom_jitter(aes(color = year))
```

> Shown above is the initial jittered plot I made with the number of days of reported prescription use by types of addictive benzodiazepines. Color was initially used to show differences in reporting in 2001 compared to 2015. This plot does show the distribution of the amount of time using prescriptions, but it is hard to interpret. It is very difficult to detect any differences according to year because there is so much overlap among the colored jittered points. Further, the values for the number of days reported on the y axis are so high, that it is hard to interpret. 

### First Revision

```{r revised1_plot2}
ggplot(rpud, aes(use_yr, fct_reorder(drug, use_yr), fill = drug)) +
  geom_density_ridges(aes(color = drug),
                      alpha = .5) +
  facet_wrap(~ year) +
  scale_y_discrete(breaks = c("LORAZEPAM", "CLONAZEPAM", "DIAZEPAM", "ALPRAZOLAM"),
                   labels = c("Ativan", "Klonopin", "Valium", "Xanax")) + 
  theme(axis.title.y = element_blank(),
        legend.position = "none")

```

> This is the first revision of the initial plot. To clearly see the differences according to year, I changed the jittered plot to a ridgeline density plot and faceted by year. Further, I transformed the days of use to years of use that is more intuitive. Additional revisions included: transforming the name of the prescriptions to their generic names so it is more accessible to non-medical audiences and deleting the axis title that is redundant; factor reordering prescription categories so that those with most/less use are easier to identify; adding color for prescription categories since that is the main variable of interest; and removing the legend that referenced the categories since it is double encoding. This plot is a big improvement over the initial plot, but there are still other revisions that could be made to improve the visualization.

### Second Revision

```{r revise2_p2}
ggplot(rpud, aes(use_yr, fct_reorder(drug, use_yr), fill = drug)) +
  geom_density_ridges(aes(color = drug),
                      scale = .95,
                      alpha = .5, 
                      jittered_points = TRUE, 
                      position = position_points_jitter(width = .1, 
                                                        height = 0), 
                      point_shape = '|', 
                      point_size = 2, 
                      point_alpha = .4) +
  facet_wrap(~ year) +
  scale_y_discrete(breaks = c("LORAZEPAM", "CLONAZEPAM", "DIAZEPAM", "ALPRAZOLAM"),
                   labels = c("Ativan", "Klonopin", "Valium", "Xanax")) + # or delete and change case str_to_title and use specific name?
  scale_x_continuous(limits = c(0,40)) +
  theme(legend.position = "none",
        axis.title.y = element_blank()) +
  labs(x = "Years of use",
       title = "Distribution of Addictive Benzodiazepine Prescription Use",
       subtitle = "Differences in 2001 vs 2015 use in the U.S.",
       caption = "Data from the CDC's National Health and Nutrition Examination Survey") +
  scale_fill_viridis_d() +
  scale_color_viridis_d()
```

> To more accurately portray the data in this visualization aimed towards an academic audience, I made two major changes. The first was limiting the x axis to begin at 0 years of use because there are not any values in the dataset that would be below 0. Second, I added a layer to plot to show the actual jittered points that underly the distributions and further show frequency and variability in responses. The default jittered point shape was changed to a bar so that the points are narrower and there is less overlap. Other refinements included: adding an explanatory title, subtitle, and caption; changing the color pallete to a professional, color blind friendly pallete that would transfer well to black and white print; and changing the scale of the ridgeline density areas so that there is no overlap among the areas to better see the added jitter points and clearly distinguish among the categories. 

### Third Revision

```{r revise3_p2}
ggplot(rpud1, aes(use_yr, year, fill = drug)) +
  geom_density_ridges(aes(color = drug),
                      scale = .9,
                      alpha = .5, 
                      jittered_points = TRUE, 
                      position = position_points_jitter(width = .1, 
                                                        height = 0), 
                      point_shape = '|', 
                      point_size = 2, 
                      point_alpha = .35) +
  facet_wrap(~ drug) +
  scale_x_continuous(limits = c(0,40)) +
  theme(legend.position = "none",
        axis.title.y = element_blank()) +
  labs(x = "Years of reported use",
       title = "Distribution of Addictive Benzodiazepine Prescription Use",
       subtitle = "Differences in the number of years of reported use in 2001 vs. 2015 in the U.S.",
       caption = "Data from the CDC's National Health and Nutrition Examination Survey\n2001 Sample (n = 18,418) and 2015 Sample (n = 19,647)") +
  scale_fill_viridis_d() +
  scale_color_viridis_d()
```

> In this revision I changed the facet to prescription type and put year on the y axis so that each comparison I am trying to make is easier to see. For example, it is not easier to see differences between the years for each drug type. Further, I clarified the title and caption to be more descriptive of the data per a peer review comment about the confusion about years being the unit for both axes. Although this plot more clearly communicates the data, there are still stylistic changes that could improve this plot, such as changing the size and color of some font and more clearly defining the jittered points. 

# Evolution of Plot 3 {data-icon="fa-graduation-cap"}

Sidebar Title {.sidebar}
----------------------

This plot is geared towards an academic audience and aims to show differences in the age of first substance use by income for each illicit substance type. 

For the final version of this plot, I made the following revisions:

* Created my own customized dark theme to have a black background and light grey text/gridlines to better see clusters of overlap among the jittered point distribution

* Changed the color of the error bars and point estimates to white so they stand out in the dark theme

* Reverted back to the default colors for the groups becuase they are brighter and easier to see against the black background

This final visualization is my favorite to look at and was my favorite to work on. There were so many options available for plotting the differences I was interested in. I think that the addition of the dark theme and bright points does a great job and clearly and accurately displaying all the information that I wanted to get accross and it is visually appealing. This was also my first time using two data frames in the same plot - which was a major challenge and eventual victory!


Column {data-width=800}
-----------------------------------------------------------------------

### Final Revised Plot 3 

```{r final_p3, fig.width=7}
p + theme(plot.background = element_rect(fill = "gray10"),
        axis.text = element_text(colour = "gray80"),
        axis.title = element_text(colour = "gray80"),
        plot.title = element_text(colour = "gray80"),
        plot.subtitle = element_text(colour = "gray80"),
        plot.caption = element_text(colour = "gray80", vjust = 1),
        panel.grid.major = element_line(colour = "gray30"), 
        panel.grid.minor = element_line(colour = "gray30"),
        strip.text = element_text(color = "gray90")) +
  geom_errorbar(aes(ymin = avg_age + qnorm(.025)*se,
                    ymax = avg_age + qnorm(.975)*se),
                width = .4,
                color = "gray90") +
  geom_point(size = 1, color = "gray90")
```

> This plot shows differences in the distribution and mean age of first illicit substance use accross various education levels using data from the 2013-2015 NHANES samples. There are no observable significant differences in mean age of first use accross education levels. Although it is interesting to note that those with no high school degree reported using substances at slightly older age than those with a college degree. The most obvious observation is that more people reported using cocaine compared to both meth and heroin. However, there seems to be more variability in age of first heroin use as seen by the distribution of data points, although there were much less participants reporting any heroin use. 

Column {.tabset data-commentary-height=1200}
-----------------------------------------------------------------------

### Initial Plot 

```{r initial_p3}
ggplot(pd, aes(income, age_use)) + 
  geom_col(aes(fill = sex), position = "dodge") + 
  facet_wrap(~ drug)
```

> The initial plot above to show differences in age of drug use by income levels and sex is not interpretable becuase of the number of income categories that are in the dataset. Further, there doesn't seem to be many observable differences for how many different categories there are. This may be due to the scale that the original researcher used. The second major problem in this plot is that it is not plotting age of use on y axis as expected, but a sum of age of use for each income group. 


### First Revision

```{r p3_bar}
sum_pd1 <- pd1 %>% 
  group_by(drug, education, sex) %>% 
  summarize(avg_age = mean(age_use),
            n = length(age_use),
            sd = sd(age_use),
            se = sd / sqrt(n))


ggplot(sum_pd1, aes(fct_reorder(drug, avg_age), avg_age)) + 
  geom_col(aes(fill = sex), position = "dodge") +
  facet_wrap(~ education)

```

> In the first revision of this plot, I substituted education groups for income levels, since there are less inherent categories and the two are similar contructs of socioeconomic status. Also, I summarized and plotted a mean age of first use by substance type, income, and sex instead of the previous count. As you can see, there are not many observable differences related to sex. So, to reduce grouping variables and make the plot more succinct, I will take out sex from these data in the next rendition. Although this plot does show differences in average age of use, it doesn't show any uncertainty around the estimate or the actual distribution of the data that would be interpretable and helpful for an academic audience. 

### Third Revision

```{r revise3_p3}
ggplot(pd1_rev_sum, aes(education, avg_age)) + 
  geom_jitter(aes(x = education, y = age_use), data = pd1_rev_filter, alpha = .15, width = .25, color = "maroon") +
  geom_errorbar(aes(ymin = avg_age + qnorm(.025)*se,
                    ymax = avg_age + qnorm(.975)*se),
                width = .4) +
  geom_point(size = 1) + 
  facet_wrap(~ drug) + 
  coord_flip() 
```

> The major revision that is apparent in the plot above is substituting a mean point estimate and error bars  instead of the columns on the previous plot. This results in a more accurate depiction of the estimate and underlying distribution. The plot is further enhanced by using the raw dataset to show the jittered distribution of each participant response to futher clarify the underlying distribution and make it possible to identify extreme cases. Additionally, I changed the facet to substance type flipped the x and y axis so that it is easier to make comparisons and see differences between the income levels for each substance. Other minor revision included: manually releveling the education categories to align with the progression through education, filtering out the missing response category for income, and decreasing transparency of underlying jittered points to see areas of high overlap.

### Fourth Revision

```{r density}
ggplot(pd1_rev_sum, aes(avg_age, education)) + 
  stat_confidence_density(aes(moe = se),
                          fill = "maroon",
                          height = .45) +
  xlim(15, 35) +
  geom_point(alpha = .8, size = 1) +
  facet_wrap(~drug, ncol = 1) +
  geom_text(aes(avg_age, education, label = round(avg_age, 1)),
            nudge_x = 1.5,
            nudge_y = .4,
            size = 3,
            color = "gray60") +
  labs(title = "Differences in average age of first substance use based on education level",
       x = "Average age of first use (in years)",
       y = "",
       caption = "Data from the CDC's National Health and Nutrition Examination Survey (2013-2015)") +
  theme(plot.title = element_text(hjust = 1))
  
```

> In this plot I was attempting to show most of the same information as in the previous plot, but without so much information in the plotting area. I decided to try showing the uncertainty around the point estimate with the `ungeviz` package. The first time I tried this, it was very difficult to see the uncertainty, especially for cocaine, because the x axis was still on the original scale (from 10 - 50 years), so I had to limit the scale to a shorter age range. This skewed the scale of the differences in the data, so I decided to add labels for the point estimates and nudge them so the viewer can tell exactly how many years each group differs by. Another major revision here is the decision to force the facets into one column so that it is easier to make comparisons accross substance types.  I also added a title and caption to this plot. I do appreciate how much cleaner this plot is compared to the previous (as noted by my peer reviewers), but I prefer being able to see the raw distribution and extreme values as well as differences in the number of people reporting at all (e.g., number of jittered points). Since this plot is aimed at an academic audience, I believe that including these components is appropriate and more accurately describes the data.


### Fifth Revision

```{r revised_white}
p  +
  scale_color_OkabeIto(darken = .2)
```

> For this revision above, I kept the facet as substance type and forced in one column from the previous plot, but changed the plot data back to the original axis scale, distribution, and point estimate to more accurately portray the data. I also decided to use color to double encode the categories on the y axis. This minor change really makes it easier to compare accross groups and substances and reduces cognitive load. I choose a colorblind friendly pallete, but had to darken the OkabeIto pallete because the yellow was hard to see. I also clarified the title and added a subtitle to explain this plot since it is a little more complex than the previous. 


